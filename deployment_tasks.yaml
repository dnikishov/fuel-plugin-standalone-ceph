# These tasks will be merged into deployment graph. Here you
# can specify new tasks for any roles, even built-in ones.

# Groups
- id: primary-radosgw
  type: group
  role: [primary-standalone-ceph-mon]
  requires:
    - controller
  required_for: [ceph-osd]
  tasks:
    - fuel_pkgs
    - hiera
    - globals
    - tools
    - logging
    - netconfig
    - hosts
    - firewall
    - reserved_ports
    - ssl-add-trust-chain
    - ceph-mon-hiera-override
    #- ceph-mon-firewall
    - apache
    - primary-cluster
    - virtual_ips
    - primary-cluster-haproxy
  parameters:
    strategy:
      type: one_by_one

- id: radosgw
  type: group
  role: [standalone-ceph-mon]
  requires:
    - primary-ceph-mon
  required_for: [deploy_end]
  tasks: 
    - fuel_pkgs
    - hiera
    - globals
    - tools
    - logging
    - netconfig
    - connectivity_tests
    - hosts
    - firewall
    - reserved_ports
    - ssl-add-trust-chain
    - ceph-mon-hiera-override
    #- ceph-mon-firewall
    - apache
    - primary-cluster
    - virtual_ips
    - primary-cluster-haproxy
  parameters:
    strategy:
      type: parallel

- id: ceph-mon-group
  type: group
  role: [ceph-mon]
  required_for: [ceph-osd, deploy_end]
  tasks: 
    - fuel_pkgs
    - hiera
    - globals
    - tools
    - logging
    - netconfig
    - connectivity_tests
    - hosts
    - firewall
    - reserved_ports
    - ssl-add-trust-chain
    - ceph-mon-hiera-override
    #- ceph-mon-firewall
  parameters:
    strategy:
      type: one_by_one


# Disable tasks on controller node
- id: ceph-mon
  type: skipped

- id: primary-ceph-mon
  type: skipped

- id: ceph-radosgw
  type: skipped

- id: primary-ceph-radosgw
  type: skipped

- id: openstack-haproxy-radosgw
  type: skipped

- id: swift-keystone
  type: skipped

- id: enable_rados
  type: skipped


# Redefine these tasks using custom names to avoid
# conflicts
- id: ceph-mon-task
  type: puppet
  version: 2.1.0
  groups: [ceph-mon-group]
  required_for: [deploy_end]
  requires: [ceph-mon-firewall, ceph-mon-hiera-override]
  condition:
    yaql_exp: &ceph_mon >
      changedAny($.storage, $.quantum, $.network_metadata,
      $.get('use_syslog'), $.get('syslog_log_facility_ceph'), $.keystone,
      $.network_metadata.nodes.values().where(
        ('standalone-ceph-mon' in $.node_roles) or
        ('primary-standalone-ceph-mon' in $.node_roles)),
      $.network_scheme, $.get('syslog_log_level_ceph'))
  cross-depended-by:
    - name: top-role-ceph-osd
  parameters:
    puppet_manifest: /etc/puppet/modules/osnailyfacter/modular/ceph/mon.pp
    puppet_modules: /etc/puppet/modules
    timeout: 3600

- id: ceph-mon-hiera-override
  type: puppet
  version: 2.1.0
  required_for: [netconfig]
  requires: [hiera, globals]
  condition:
    yaql_exp: *ceph_mon
  parameters:
    puppet_manifest: ceph-mon-hiera-override.pp
    puppet_modules: /etc/puppet/modules:modules
    timeout: 3600
